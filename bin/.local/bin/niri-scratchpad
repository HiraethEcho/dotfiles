#!/usr/bin/env sh

# This script is based on:
# https://github.com/gvolpe/nix-config/blob/f86ab83a3976807a11e57477abe1648b46ac7c56/home/wm/niri/scripts.nix#L12
# https://github.com/YaLTeR/niri/discussions/329
#
# Find this name via e.g. $ niri msg windows, and find the "App ID"
SCRATCH_WIN_NAME=$1

[ -z "$SCRATCH_WIN_NAME" ] && notify-send "No scratchpad window name received - exiting" && exit 1

get_window_objects() {
  SCRATCH_WIN_NAME="$1"
  niri msg -j windows | jq ".[] | select(.app_id == \"$SCRATCH_WIN_NAME\")"
}

# Couldn't just use the window name here for launching because the binary name is sometimes different
if [ -z "$(get_window_objects "$SCRATCH_WIN_NAME")" ]; then
  if [ "$SCRATCH_WIN_NAME" = "kitty" ]; then
    setsid kitty &
  else
    notify-send -u critical 'Scratchpad Error' "There are no window ids for: $SCRATCH_WIN_NAME" -t 5000
    exit 1
  fi
  notify-send "Launching $SCRATCH_WIN_NAME"
  sleep 3
fi

ID_CURRENT_WORKSPACE=$(niri msg -j workspaces | jq '.[] | select(.is_focused == true)' | jq .idx)

ANY_SCRATCH_WIN_FOCUSED=$(niri msg -j windows | jq ".[] | select(.app_id == \"$SCRATCH_WIN_NAME\").is_focused" | grep "true")

get_window_objects "$SCRATCH_WIN_NAME" | jq -c | while read WIN_OBJ; do

  WIN_ID=$(echo "$WIN_OBJ" | jq .id)

  if [ "$ANY_SCRATCH_WIN_FOCUSED" = "true" ]; then  # Hide
    niri msg action move-window-to-workspace --window-id "$WIN_ID" 3 --focus=false
    niri msg action move-window-to-tiling --id "$WIN_ID"
  else  # Show
    niri msg action move-window-to-workspace --window-id "$WIN_ID" "$ID_CURRENT_WORKSPACE"
    niri msg action move-window-to-floating --id "$WIN_ID"
    niri msg action focus-window --id "$WIN_ID"
    niri msg action set-window-width "50%"
    niri msg action set-window-height "80%"
    niri msg action center-window 
  fi
done
